from contextlib import suppress
from aiogram import Router, F
from aiogram.fsm.context import FSMContext
from aiogram.types import CallbackQuery, Message, InputMediaAnimation, InputMediaPhoto
from aiogram.exceptions import TelegramBadRequest
from filters.chat_type import ChatTypeFilter
from keyboards import builders
from data import mongodb, character_photo

router = Router()


async def get_inventory(user_id, rarity):
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    invent = account['inventory']['characters'][universe]
    return invent[rarity], universe


@router.message(
    ChatTypeFilter(chat_type=["private"]),
    F.text == "ğŸ¥¡ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ"
)
@router.callback_query(F.data == "inventory")
async def inventory(callback: CallbackQuery | Message):
    media_id = "CgACAgIAAxkBAAIVCmXMvbzs7hde-fvY9_4JCwU8W6HpAAKgOwACeyZoSuedvZenkxDNNAQ"
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    total_divine = len(account['inventory']['characters'][universe].get('divine', {}))
    total_mythical = len(account['inventory']['characters'][universe].get('mythical', {}))
    total_legendary = len(account['inventory']['characters'][universe].get('legendary', {}))
    total_epic = len(account['inventory']['characters'][universe].get('epic', {}))
    total_rare = len(account['inventory']['characters'][universe].get('rare', {}))
    total_common = len(account['inventory']['characters'][universe].get('common', {}))
    total_elements = 0
    for sublist in account['inventory']['characters'][universe].values():
        for item in sublist:
            if isinstance(item, str):
                total_elements += 1
    pattern = dict(caption=f"ğŸ¥¡ Ğ˜Ğ½Ğ²ĞµĞ½Ñ‚Ğ°Ñ€ÑŒ"
                           f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                           f"\nâ– Ğ—Ğ´ĞµÑÑŒ Ğ²Ñ‹ Ğ¼Ğ¾Ğ¶ĞµÑ‚Ğµ ÑƒĞ²Ğ¸Ğ´ĞµÑ‚ÑŒ Ğ²ÑĞµ Ğ²Ğ°ÑˆĞ¸ ğŸƒ ĞºĞ°Ñ€Ñ‚Ñ‹ "
                           f"Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ¸Ñ… Ğ² ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğµ ğŸ´ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°"
                           f"\n\nâ– Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ âœ¨ Ñ€ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ ĞºĞ°Ñ€Ñ‚Ñ‹, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ"
                           f"\nâ”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                           f"\nâ– ğŸƒ ĞšĞ¾Ğ»Ğ¸Ñ‡ĞµÑÑ‚Ğ²Ğ¾ ĞºĞ°Ñ€Ñ‚: {total_elements}",
                   reply_markup=builders.inline_builder(
                       [f"ğŸŒ  Ğ‘Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ğŸŒŸ {total_divine}", f"ğŸŒŒ ĞœĞ¸Ñ„Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_mythical}",
                        f"ğŸŒ… Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°Ñ€Ğ½Ñ‹Ğµ â­ï¸ {total_legendary}", f"ğŸ† Ğ­Ğ¿Ğ¸Ñ‡ĞµÑĞºĞ¸Ğµ â­ï¸ {total_epic}",
                        f"ğŸ‡ Ğ ĞµĞ´ĞºĞ¸Ğµ â­ï¸ {total_rare}", f"ğŸŒ ĞĞ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ â­ï¸ {total_common}", "ğŸ”™ ĞĞ°Ğ·Ğ°Ğ´"],
                       ["divine", "mythical", "legendary", "epic", "rare", "common", "main_page"], row_width=[1]))
    if isinstance(callback, CallbackQuery):
        inline_id = callback.inline_message_id
        media = InputMediaAnimation(media=media_id)
        await callback.message.edit_media(media, inline_id)
        await callback.message.edit_caption(inline_id, **pattern)
    else:
        await callback.answer_animation(media_id, **pattern)


@router.callback_query(F.data.in_(['common', 'rare', 'epic', 'legendary', 'mythical', 'divine']))
async def inventory(callback: CallbackQuery, state: FSMContext):
    await state.update_data(rarity=callback.data)
    inline_id = callback.inline_message_id
    user_id = callback.from_user.id
    invent, universe = await get_inventory(user_id, callback.data)
    if invent == []:
        await callback.answer("â– âœ–ï¸ Ğ£ Ğ²Ğ°Ñ Ğ½ĞµÑ‚ ĞºĞ°Ñ€Ñ‚ Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¹ Ñ€ĞµĞ´ĞºĞ¾ÑÑ‚Ğ¸", show_alert=True)
        return
    await state.update_data(character=invent[0])
    await state.update_data(universe=universe)
    avatar = character_photo.get_stats(universe, invent[0], 'avatar')
    avatar_type = character_photo.get_stats(universe, invent[0], 'type')
    if avatar_type == 'photo':
        photo = InputMediaPhoto(media=avatar)
    else:
        photo = InputMediaAnimation(media=avatar)
    rarity = character_photo.get_stats(universe, invent[0], 'rarity')
    msg = f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
    if universe not in ['Allstars', 'Allstars(old)']:
        strength = character_photo.get_stats(universe, invent[0], 'arena')['strength']
        agility = character_photo.get_stats(universe, invent[0], 'arena')['agility']
        intelligence = character_photo.get_stats(universe, invent[0], 'arena')['intelligence']
        power = character_photo.get_stats(universe, invent[0], 'arena')['power']
        msg = (f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
               f"\nâ– ğŸ—º Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ: {universe}"
               f"\n\n   âœŠğŸ» Ğ¡Ğ¸Ğ»Ğ°: {strength}"
               f"\n   ğŸ‘£ Ğ›Ğ¾Ğ²ĞºĞ¾ÑÑ‚ÑŒ: {agility}"
               f"\n   ğŸ§  Ğ˜Ğ½Ñ‚ĞµĞ»ĞµĞºÑ‚: {intelligence}"
               f"\n   âšœï¸ ĞœĞ¾Ñ‰ÑŒ: {power}")
    await callback.message.edit_media(photo, inline_id)
    await callback.message.edit_caption(inline_id, caption=f"ğŸ´ {invent[0]}"
                                                           f"\n â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                                                           f"{msg}"
                                                           f"\nâ”€â”€â€*Ì¥Ëšâ”€â”€â—Œâ”€â”€â—Œâ”€â”€â€*Ì¥Ëšâ”€â”€â”€â”€"
                                                           f"\nâ– ğŸ”– 1 Ğ¸Ğ· {len(invent)}",
                                        reply_markup=builders.pagination_keyboard(universe, invent[0]))


@router.callback_query(builders.Pagination.filter(F.action.in_(["prev", "next"])))
async def inventory(callback: CallbackQuery, callback_data: builders.Pagination, state: FSMContext):
    inline_id = callback.inline_message_id
    page_num = int(callback_data.page)
    user_data = await state.get_data()
    invent, universe = await get_inventory(callback.from_user.id, user_data['rarity'])

    if callback_data.action == "next":
        page_num = (page_num + 1) % len(invent)
    elif callback_data.action == "prev":
        page_num = (page_num - 1) % len(invent)

    with suppress(TelegramBadRequest):
        await state.update_data(character=invent[page_num])
        avatar = character_photo.get_stats(universe, invent[page_num], 'avatar')
        avatar_type = character_photo.get_stats(universe, invent[page_num], 'type')
        if avatar_type == 'photo':
            photo = InputMediaPhoto(media=avatar)
        else:
            photo = InputMediaAnimation(media=avatar)
        rarity = character_photo.get_stats(universe, invent[page_num], 'rarity')
        msg = f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
        if universe not in ['Allstars', 'Allstars(old)']:
            strength = character_photo.get_stats(universe, invent[page_num], 'arena')['strength']
            agility = character_photo.get_stats(universe, invent[page_num], 'arena')['agility']
            intelligence = character_photo.get_stats(universe, invent[page_num], 'arena')['intelligence']
            power = character_photo.get_stats(universe, invent[page_num], 'arena')['power']
            msg = (f"\nâ– âœ¨ Ğ ĞµĞ´ĞºĞ¾ÑÑ‚ÑŒ: {rarity}"
                   f"\nâ– ğŸ—º Ğ’ÑĞµĞ»ĞµĞ½Ğ½Ğ°Ñ: {universe}"
                   f"\n\n   âœŠğŸ» Ğ¡Ğ¸Ğ»Ğ°: {strength}"
                   f"\n   ğŸ‘£ Ğ›Ğ¾Ğ²ĞºĞ¾ÑÑ‚ÑŒ: {agility}"
                   f"\n   ğŸ§  Ğ˜Ğ½Ñ‚ĞµĞ»ĞµĞºÑ‚: {intelligence}"
                   f"\n   âšœï¸ ĞœĞ¾Ñ‰ÑŒ: {power}")

        await callback.message.edit_media(photo, inline_id)
        await callback.message.edit_caption(
            inline_id,
            caption=f"ğŸ´ {invent[page_num]}"
                    f"\n â”€â”€ â€¢âœ§âœ§â€¢ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
                    f"{msg}"
                    f"\nâ”€â”€â€*Ì¥Ëšâ”€â”€â—Œâ”€â”€â—Œâ”€â”€â€*Ì¥Ëšâ”€â”€â”€â”€"
                    f"\nâ– ğŸ”– {page_num + 1} Ğ¸Ğ· {len(invent)}",
            reply_markup=builders.pagination_keyboard(universe=universe, character=invent[page_num], page=page_num)
        )
    await callback.answer()


@router.callback_query(F.data == "change_character")
async def change_ch(callback: CallbackQuery, state: FSMContext):
    user_id = callback.from_user.id
    data = await state.get_data()
    await mongodb.change_char(user_id, data.get('universe'), data.get('character'))
    await callback.answer("ğŸ´ Ğ’Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ Ğ¿ĞµÑ€ÑĞ¾Ğ½Ğ°Ğ¶Ğ°", show_alert=True)
