from datetime import datetime
from aiogram import Router, F
from contextlib import suppress

from aiogram.exceptions import TelegramBadRequest
from aiogram.enums import ParseMode
from aiogram.types import CallbackQuery, InputMediaAnimation, InputMediaPhoto, Message

from data import mongodb
from data.character_photo import get_stats
from keyboards.builders import inline_builder, Pagination, pagination_dungeon
from recycling import profile
from filters.chat_type import ChatTypeFilter
from data import character_photo
from aiogram.fsm.context import FSMContext

router = Router()


@router.message(ChatTypeFilter(chat_type=["private"]), F.text == "‚õ©Ô∏è –ü–æ–¥–∑–µ–º–µ–ª—å–µ")
@router.callback_query(F.data == "dungeon")
async def dungeon(callback: CallbackQuery | Message):
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']

    # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    current_datetime = datetime.now()

    # –ü–æ—Å–ª–µ–¥–Ω—è—è –ø—Ä–æ–¥–∞–∂–∞
    last_sell_datetime = account['tasks'].get('last_dungeon', current_datetime)
    if isinstance(last_sell_datetime, str):  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        last_sell_datetime = datetime.fromisoformat(last_sell_datetime)

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
    elapsed_seconds = int((current_datetime - last_sell_datetime).total_seconds())

    if "deck_dungeon" not in account:
        await mongodb.update_user(user_id, {"deck_dungeon": {
            "dg1": "empty",
            "dg1_universe": "empty",
            "dg2": "empty",
            "dg2_universe": "empty",
            "dg3": "empty",
            "dg3_universe": "empty",
            "dg4": "empty",
            "dg4_universe": "empty",
            "dg5": "empty",
            "dg5_universe": "empty",
            "dg6": "empty",
            "dg6_universe": "empty"
        }})
        account = await mongodb.get_user(user_id)
        text = "‚ÄºÔ∏è –û—Ç—Ä—è–¥ –ø—É—Å—Ç–æ–π"
        power = 0

    deck_data = account["deck_dungeon"]
    first = deck_data["dg1"]
    first_universe = deck_data["dg1_universe"]
    second = deck_data["dg2"]
    second_universe = deck_data["dg2_universe"]
    third = deck_data["dg3"]
    third_universe = deck_data["dg3_universe"]
    fourth = deck_data["dg4"]
    fourth_universe = deck_data["dg4_universe"]
    fifth = deck_data["dg5"]
    fifth_universe = deck_data["dg5_universe"]
    sixth = deck_data["dg6"]
    sixth_universe = deck_data["dg6_universe"]

    if first == "empty":
        first = 0
    else:
        p = get_stats(first_universe, first, 'arena')
        first = p.get('power')
    if second == "empty":
        second = 0
    else:
        p = get_stats(second_universe, second, 'arena')
        second = p.get('power')
    if third == "empty":
        third = 0
    else:
        p = get_stats(third_universe, third, 'arena')
        third = p.get('power')
    if fourth == "empty":
        fourth = 0
    else:
        p = get_stats(fourth_universe, fourth, 'arena')
        fourth = p.get('power')
    if fifth == "empty":
        fifth = 0
    else:
        p = get_stats(fifth_universe, fifth, 'arena')
        fifth = p.get('power')
    if sixth == "empty":
        sixth = 0
    else:
        p = get_stats(sixth_universe, sixth, 'arena')
        sixth = p.get('power')

    power = first + second + third + fourth + fifth + sixth
    text = f"‚öúÔ∏è –°–∏–ª–∞ –æ—Ç—Ä—è–¥–∞: {power}üó°"

    # –ü—Ä–∏—Ä–æ—Å—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞ —á–∞—Å
    nephritis_per_hour = power // 1000
    gold_per_hour = power // 200
    silver_per_hour = power // 40

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏—Ä–æ—Å—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—Ä–æ–¥–∞–∂–∏
    current_nephritis = max(0, int(account['campaign']['nephritis'] + (nephritis_per_hour * (elapsed_seconds // 60 // 60))))
    current_gold = max(0, int(account['campaign']['gold'] + (gold_per_hour * (elapsed_seconds // 60 // 60))))
    current_silver = max(0, int(account['campaign']['silver'] + (silver_per_hour * (elapsed_seconds // 60 // 60))))

    if current_nephritis < 1:
        current_nephritis = "0.~"

    if nephritis_per_hour < 1:
        nephritis_per_hour = "0.~"
    level = await profile.level(account['campaign']['level'])

    pattern = dict(
        caption=f"‚ùñ  ‚õ©Ô∏è  <b>‡πë€©–ü–æ–¥–∑–µ–º–µ–ª—å–µ€©‡πë</b>"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                f"\nüïØ –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç—ã —Å–æ–±–∏—Ä–∞—é—Ç üó°"
                f"\nüí∞ –†–µ—Å—É—Ä—Å—ã:"
                f"\n<blockquote>üí† –ù–µ—Ñ—Ä–∏—Ç—ã: {current_nephritis} ‚ä± <i>{nephritis_per_hour} –≤ —á–∞—Å</i>"
                f"\nüìÄ –ó–æ–ª–æ—Ç–æ: {current_gold} ‚ä± <i>{gold_per_hour} –≤ —á–∞—Å</i>"
                f"\nüíø –°–µ—Ä–µ–±—Ä–æ: {current_silver} ‚ä± <i>{silver_per_hour} –≤ —á–∞—Å</i></blockquote>"
                f"\n{text}"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                f"\n‚öñÔ∏è –¶–µ–Ω—ã –∑–∞ —Ä–µ—Å—É—Ä—Å—ã: "
                f"\n<blockquote>üí† ‚ä± 26 ¬•"
                f" üìÄ ‚ä± 10 ¬•"
                f" üíø ‚ä± 4 ¬•</blockquote>",
        reply_markup=inline_builder(
            ["üïØ –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç—ã üó°", "üí∞ –ü—Ä–æ–¥–∞—Ç—å üí¥", "‚öúÔ∏è –†–µ–π—Ç–∏–Ω–≥", "üîô –ù–∞–∑–∞–¥", "üìã –ü—Ä–∞–≤–∏–ª–∞"],
            ["deck_dungeon", "sell_resources", "campaign_rank", "tokio", "campaign_rules"],
            row_width=[1, 2, 2]
        )
    )

    media_id = "AgACAgIAAx0CfstymgACGttmw1rY8-Urz0Hyjku-8S34cRDuMgACk-ExG8b4GEr9GXvbgCanOgEAAwIAA3kAAzUE"
    media = InputMediaPhoto(media=media_id)

    if isinstance(callback, CallbackQuery):
        await callback.message.edit_media(media)
        await callback.message.edit_caption(**pattern)
    else:
        await callback.answer_photo(photo=media_id, **pattern)


@router.callback_query(F.data == "sell_resources")
async def sell_resources(callback: CallbackQuery):
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)

    universe = account['universe']

    # –¢–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è
    current_datetime = datetime.now()

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
    last_sell_datetime = account['tasks'].get('last_dungeon', current_datetime)
    if isinstance(last_sell_datetime, str):  # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        last_sell_datetime = datetime.fromisoformat(last_sell_datetime)

    elapsed_seconds = int((current_datetime - last_sell_datetime).total_seconds())

    deck_data = account["deck_dungeon"]
    if all(value == "empty" for value in deck_data.values()):
        await callback.answer("‚ùñ ‚úñÔ∏è –û—Ç—Ä—è–¥ –ø—É—Å—Ç–æ–π", show_alert=True)
        return
    if "deck_dungeon" not in account:
        await mongodb.update_user(user_id, {"deck_dungeon": {
            "dg1": "empty",
            "dg1_universe": "empty",
            "dg2": "empty",
            "dg2_universe": "empty",
            "dg3": "empty",
            "dg3_universe": "empty",
            "dg4": "empty",
            "dg4_universe": "empty",
            "dg5": "empty",
            "dg5_universe": "empty",
            "dg6": "empty",
            "dg6_universe": "empty"
        }})
        account = await mongodb.get_user(user_id)
        text = "‚ÄºÔ∏è –û—Ç—Ä—è–¥ –ø—É—Å—Ç–æ–π"
        power = 0

    deck_data = account["deck_dungeon"]
    first = deck_data["dg1"]
    first_universe = deck_data["dg1_universe"]
    second = deck_data["dg2"]
    second_universe = deck_data["dg2_universe"]
    third = deck_data["dg3"]
    third_universe = deck_data["dg3_universe"]
    fourth = deck_data["dg4"]
    fourth_universe = deck_data["dg4_universe"]
    fifth = deck_data["dg5"]
    fifth_universe = deck_data["dg5_universe"]
    sixth = deck_data["dg6"]
    sixth_universe = deck_data["dg6_universe"]

    if first == "empty":
        first = 0
    else:
        p = get_stats(first_universe, first, 'arena')
        first = p.get('power')
    if second == "empty":
        second = 0
    else:
        p = get_stats(second_universe, second, 'arena')
        second = p.get('power')
    if third == "empty":
        third = 0
    else:
        p = get_stats(third_universe, third, 'arena')
        third = p.get('power')
    if fourth == "empty":
        fourth = 0
    else:
        p = get_stats(fourth_universe, fourth, 'arena')
        fourth = p.get('power')
    if fifth == "empty":
        fifth = 0
    else:
        p = get_stats(fifth_universe, fifth, 'arena')
        fifth = p.get('power')
    if sixth == "empty":
        sixth = 0
    else:
        p = get_stats(sixth_universe, sixth, 'arena')
        sixth = p.get('power')

    power = first + second + third + fourth + fifth + sixth

    # –ü—Ä–∏—Ä–æ—Å—Ç —Ä–µ—Å—É—Ä—Å–æ–≤ –∑–∞ —á–∞—Å
    nephritis_per_hour = power // 1000
    gold_per_hour = power // 200
    silver_per_hour = power // 40

    # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–∏—Ä–æ—Å—Ç —Ä–µ—Å—É—Ä—Å–æ–≤
    nephritis_earned = max(0, int(account['campaign']['nephritis'] + (nephritis_per_hour * (elapsed_seconds // 60 // 60))))
    gold_earned = max(0, int(account['campaign']['gold'] + (gold_per_hour * (elapsed_seconds // 60 // 60))))
    silver_earned = max(0, int(account['campaign']['silver'] + (silver_per_hour * (elapsed_seconds // 60 // 60))))

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏
    if nephritis_earned < 1 and gold_earned < 1 and silver_earned < 1:
        await callback.answer("‚ùñ ‚úñÔ∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ä–µ—Å—É—Ä—Å–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–∂–∏", show_alert=True)
        return

    nephritis = 0
    gold = 0
    silver = 0

    if nephritis_earned < 1:
        nephritis = nephritis_earned
        nephritis_earned = 0
    if gold_earned < 1:
        gold = gold_earned
        gold_earned = 0
    if silver_earned < 1:
        silver = silver_earned
        silver_earned = 0

    # –°—á–∏—Ç–∞–µ–º –æ–±—â—É—é —Å—É–º–º—É
    total_money = nephritis_earned * 26 + gold_earned * 10 + silver_earned * 4

    # –û–±–Ω–æ–≤–ª—è–µ–º —Ä–µ—Å—É—Ä—Å—ã –∏ –¥–µ–Ω—å–≥–∏
    await mongodb.update_user(
        user_id, {
            'campaign.nephritis': nephritis,  # –û—Å—Ç–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫
            'campaign.gold': gold,
            'campaign.silver': silver,
            'tasks.last_dungeon': current_datetime.isoformat()
        }
    )

    await mongodb.update_user(user_id, {'account.money': total_money})

    level = await profile.level(account['campaign']['level'])

    account = await mongodb.get_user(user_id)
    current_nephritis = max(0, int(account['campaign']['nephritis'] + (nephritis_per_hour * (elapsed_seconds // 60 // 60))))
    current_gold = max(0, int(account['campaign']['gold'] + (gold_per_hour * (elapsed_seconds // 60 // 60))))
    current_silver = max(0, int(account['campaign']['silver'] + (silver_per_hour * (elapsed_seconds // 60 // 60))))

    caption = (f"‚ùñ  ‚õ©Ô∏è  <b>‡πë€©–ü–æ–¥–∑–µ–º–µ–ª—å–µ€©‡πë</b>"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                f"\nüïØ –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç—ã —Å–æ–±–∏—Ä–∞—é—Ç üó°"
                f"\nüí∞ –†–µ—Å—É—Ä—Å—ã:"
                f"\n<blockquote>üí† –ù–µ—Ñ—Ä–∏—Ç—ã: {current_nephritis} ‚ä± <i>{nephritis_per_hour} –≤ —á–∞—Å</i>"
                f"\nüìÄ –ó–æ–ª–æ—Ç–æ: {current_gold} ‚ä± <i>{gold_per_hour} –≤ —á–∞—Å</i>"
                f"\nüíø –°–µ—Ä–µ–±—Ä–æ: {current_silver} ‚ä± <i>{silver_per_hour} –≤ —á–∞—Å</i></blockquote>"
                f"\n‚öúÔ∏è –°–∏–ª–∞ –æ—Ç—Ä—è–¥–∞: {power}üó°"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                f"\n‚öñÔ∏è –¶–µ–Ω—ã –∑–∞ —Ä–µ—Å—É—Ä—Å—ã: "
                f"\n<blockquote>üí† ‚ä± 26 ¬•"
                f" üìÄ ‚ä± 10 ¬•"
                f" üíø ‚ä± 4 ¬•</blockquote>")

    await callback.message.edit_caption(inline_message_id=callback.inline_message_id, caption=caption, reply_markup=inline_builder(
            ["üïØ –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç—ã üó°", "üí∞ –ü—Ä–æ–¥–∞—Ç—å üí¥", "‚öúÔ∏è –†–µ–π—Ç–∏–Ω–≥", "üîô –ù–∞–∑–∞–¥", "üìã –ü—Ä–∞–≤–∏–ª–∞"],
            ["deck_dungeon", "sell_resources", "campaign_rank", "tokio", "campaign_rules"],
            row_width=[1, 2, 2]))
    await callback.answer(f"‚ùñ üí∞ –†–µ—Å—É—Ä—Å—ã –ø—Ä–æ–¥–∞–Ω—ã –∑–∞ {total_money}¬• üí¥", show_alert=True)


@router.callback_query(F.data == "campaign_rank")
async def campaign_rank(callback: CallbackQuery):
    account = await mongodb.get_user(callback.from_user.id)
    rating = await mongodb.send_rating("campaign.power", account, '‚öúÔ∏è')

    media = InputMediaAnimation(media="CgACAgIAAxkBAAIVQ2XOBCFYSQfjZfxblsVAZJ3PNGQWAAKIRwAC8utxSsak7XpiV9MnNAQ")
    await callback.message.edit_media(media=media)

    await callback.message.edit_caption(
        caption=f"‚ùñ  ‚öúÔ∏è  <b>–†–µ–π—Ç–∏–Ω–≥ —Å–∞–º—ã—Ö —Å–∏–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤</b>"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                f"{rating}"
                f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ",
        parse_mode=ParseMode.HTML,
        reply_markup=inline_builder(
            ["üîô –ù–∞–∑–∞–¥"],
            ["dungeon"],
            row_width=[2, 2])
    )
    await callback.answer()


@router.callback_query(F.data == "campaign_rules")
async def campaign_rules(callback: CallbackQuery):
    await callback.message.answer(
        f"‚ùñ üìã –ü—Ä–∞–≤–∏–ª–∞ –ü–æ–¥–∑–µ–º–µ–ª—å–µ"
        "\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
        "\nhttps://teletype.in/@dire_hazard/x1#DZdC",
        reply_markup=inline_builder(["‚òëÔ∏è"], ["delete"], row_width=[1]))

    await callback.answer()


def deck_text(character, universe):
    strength = character_photo.get_stats(universe, character, 'arena')['strength']
    agility = character_photo.get_stats(universe, character, 'arena')['agility']
    intelligence = character_photo.get_stats(universe, character, 'arena')['intelligence']
    clas = character_photo.get_stats(universe, character, 'arena')['class']
    hp = strength * 75
    attack = strength * 5 + agility * 5 + intelligence * 5
    defense = (strength + agility + (intelligence // 2)) // 4

    text = (f" ‚Ä¢ üé¥ {character} "
            f"\n ‚îó‚û§ ‚Ä¢ ‚ô•Ô∏è{hp} ‚Ä¢ ‚öîÔ∏è{attack} ‚Ä¢ üõ°Ô∏è{defense}"
            f"\n     ‚îó‚û§ ‚Ä¢ ‚úä{strength} ‚Ä¢ üë£{agility} ‚Ä¢ üß†{intelligence} ‚úß {clas}")
    return text


@router.callback_query(F.data == "deck_dungeon")
async def choose_card(callback: CallbackQuery):
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']

    deck = account.get("deck_dungeon", {})

    required_fields = {
        "dg1": "empty",
        "dg1_universe": "empty",
        "dg2": "empty",
        "dg2_universe": "empty",
        "dg3": "empty",
        "dg3_universe": "empty",
        "dg4": "empty",
        "dg4_universe": "empty",
        "dg5": "empty",
        "dg5_universe": "empty",
        "dg6": "empty",
        "dg6_universe": "empty"
    }

    for field, value in required_fields.items():
        if field not in deck:
            deck[field] = value

    await mongodb.update_user(user_id, {"deck_dungeon": deck})
    account = await mongodb.get_user(user_id)

    deck_data = account["deck_dungeon"]
    first = deck_data["dg1"]
    first_universe = deck_data["dg1_universe"]
    second = deck_data["dg2"]
    second_universe = deck_data["dg2_universe"]
    third = deck_data["dg3"]
    third_universe = deck_data["dg3_universe"]
    fourth = deck_data["dg4"]
    fourth_universe = deck_data["dg4_universe"]
    fifth = deck_data["dg5"]
    fifth_universe = deck_data["dg5_universe"]
    sixth = deck_data["dg6"]
    sixth_universe = deck_data["dg6_universe"]

    cards = [first, second, third, fourth, fifth, sixth]
    card_universes = [first_universe, second_universe, third_universe, fourth_universe, fifth_universe, sixth_universe]
    messages = []
    icons = []
    powers = []

    for card in cards:
        if card == "empty":
            messages.append(" ‚Ä¢ üé¥ <i> –ü—É—Å—Ç–æ–µ –º–µ—Å—Ç–æ </i>")
            icons.append("‚ÑπÔ∏è")
            powers.append(0)
        else:
            p = get_stats(card_universes[cards.index(card)], card, 'arena')
            power = p.get('power')
            messages.append(deck_text(card, card_universes[cards.index(card)]))
            icons.append("‚úÖ")
            powers.append(power)

    # –î–æ—Å—Ç—É–ø –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º
    f1_msg, f2_msg, f3_msg, f4_msg, f5_msg, f6_msg = messages
    f1_icon, f2_icon, f3_icon, f4_icon, f5_icon, f6_icon = icons
    first, second, third, fourth, fifth, sixth = powers

    power = first + second + third + fourth + fifth + sixth

    if "empty" in deck_data.values():
        msg = "‚ùÉ ‚ÑπÔ∏è –ï—Å—Ç—å –ø—É—Å—Ç—ã–µ –º–µ—Å—Ç–∞ –≤ –æ—Ç—Ä—è–¥–µ"
    else:
        msg = "‚ùÉ ‚úÖ –í–∞—à –æ—Ç—Ä—è–¥ –≥–æ—Ç–æ–≤ –∫ –ø–æ—Ö–æ–¥—É"

    pattern = dict(
        caption=f"<b>‚ùñ üïØ –ê–≤–∞–Ω—Ç—é—Ä–∏—Å—Ç—ã üó°</b>"
                f"\n‚úß‚Ä¢‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Ä¢‚úß"
                f"\n<blockquote expandable>"
                f"{f1_msg}"
                f"\n\n{f2_msg}"
                f"\n\n{f3_msg}"
                f"\n\n{f4_msg}"
                f"\n\n{f5_msg}"
                f"\n\n{f6_msg}"
                f"</blockquote>"
                f"\n ‚öúÔ∏è –°–∏–ª–∞ –æ—Ç—Ä—è–¥–∞: {power}üó°"
                f"\n‚úß‚Ä¢‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚Ä¢‚úß"
                f"\n{msg}",
        reply_markup=inline_builder(
            [f"{f1_icon}", f"{f2_icon}", f"{f3_icon}",
             f"{f4_icon}", f"{f5_icon}", f"{f6_icon}",
             "üîô –ù–∞–∑–∞–¥"],
            ["dg1", "dg2", "dg3",
             "dg4", "dg5", "dg6",
             "dungeon"],
            row_width=[3, 3, 1]
        )
    )

    media_id = InputMediaPhoto(media='AgACAgIAAx0CfstymgACPb1nWiwJUdQC-37DUnytEI6vUZd25wACMvQxG_bt0Epw17D9NcuZQAEAAwIAA3kAAzYE')

    inline_id = callback.inline_message_id
    await callback.message.edit_media(media_id, inline_id)
    await callback.message.edit_caption(inline_id, **pattern)


async def get_inventory(user_id, rarity):
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    invent = account['inventory']['characters'][universe]
    if rarity == "dg_divine":
        rarity = "divine"
    elif rarity == "dg_mythical":
        rarity = "mythical"
    elif rarity == "dg_legendary":
        rarity = "legendary"
    elif rarity == "dg_epic":
        rarity = "epic"
    elif rarity == "dg_rare":
        rarity = "rare"
    elif rarity == "dg_common":
        rarity = "common"
    elif rarity == "dg_halloween":
        rarity = "halloween"
    elif rarity == "dg_soccer":
        rarity = "soccer"
    return invent[rarity], universe


@router.callback_query(F.data.in_(['dg1', 'dg2', 'dg3', 'dg4', 'dg5', 'dg6']))
async def inventory(callback: CallbackQuery | Message, state: FSMContext):
    await state.update_data(deck=callback.data)
    if callback.data == "dg1":
        await state.update_data(card_universe="dg1_universe")
    elif callback.data == "dg2":
        await state.update_data(card_universe="dg2_universe")
    elif callback.data == "dg3":
        await state.update_data(card_universe="dg3_universe")
    elif callback.data == "dg4":
        await state.update_data(card_universe="dg4_universe")
    elif callback.data == "dg5":
        await state.update_data(card_universe="dg5_universe")
    elif callback.data == "dg6":
        await state.update_data(card_universe="dg6_universe")
    media_id = "CgACAgIAAxkBAAIVCmXMvbzs7hde-fvY9_4JCwU8W6HpAAKgOwACeyZoSuedvZenkxDNNAQ"
    user_id = callback.from_user.id
    account = await mongodb.get_user(user_id)
    universe = account['universe']
    total_divine = len(account['inventory']['characters'][universe].get('divine', {}))
    total_mythical = len(account['inventory']['characters'][universe].get('mythical', {}))
    total_legendary = len(account['inventory']['characters'][universe].get('legendary', {}))
    total_epic = len(account['inventory']['characters'][universe].get('epic', {}))
    total_rare = len(account['inventory']['characters'][universe].get('rare', {}))
    total_common = len(account['inventory']['characters'][universe].get('common', {}))
    total_elements = 0
    for sublist in account['inventory']['characters'][universe].values():
        for item in sublist:
            if isinstance(item, str):
                total_elements += 1
    msg = (f"\n‚ùñ üÉè –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç: {total_elements}"
           f"\n\n‚ùñ üå† –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ üåü {total_divine}"
           f"\n‚ùñ üåå –ú–∏—Ñ–∏—á–µ—Å–∫–∏–µ ‚≠êÔ∏è {total_mythical}"
           f"\n‚ùñ üåÖ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ ‚≠êÔ∏è {total_legendary}"
           f"\n‚ùñ üéÜ –≠–ø–∏—á–µ—Å–∫–∏–µ ‚≠êÔ∏è {total_epic}"
           f"\n‚ùñ üéá –†–µ–¥–∫–∏–µ ‚≠êÔ∏è {total_rare}"
           f"\n‚ùñ üåÅ –û–±—ã—á–Ω—ã–µ ‚≠êÔ∏è {total_common}")
    buttons = [f"üå† –ë–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ üåü {total_divine}", f"üåå –ú–∏—Ñ–∏—á–µ—Å–∫–∏–µ ‚≠êÔ∏è {total_mythical}", f"üåÖ –õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–µ ‚≠êÔ∏è {total_legendary}",
               f"üéÜ –≠–ø–∏—á–µ—Å–∫–∏–µ ‚≠êÔ∏è {total_epic}", f"üéá –†–µ–¥–∫–∏–µ ‚≠êÔ∏è {total_rare}", f"üåÅ –û–±—ã—á–Ω—ã–µ ‚≠êÔ∏è {total_common}", "üîô –ù–∞–∑–∞–¥"]
    callbacks = ["dg_divine", "dg_mythical", "dg_legendary", "dg_epic", "dg_rare", "dg_common", f"deck_dungeon"]

    if universe == "Allstars":
        if "halloween" in account['inventory']['characters']['Allstars']:
            total_halloween = len(account['inventory']['characters']['Allstars'].get('halloween', {}))
            buttons.insert(0, f"üëª Halloween üéÉ {total_halloween}")
            callbacks.insert(0, "dg_halloween")
        # if "soccer" not in account['inventory']['characters']['Allstars']:
        #     account = await mongodb.get_user(user_id)
        #     await mongodb.update_user(user_id, {"inventory.characters.Allstars.soccer": []})
        #     total_soccer = len(account['inventory']['items'].get('soccer', {}))
        #     buttons.insert(0, f"‚öΩÔ∏è Soccer {total_soccer}")
        #     callbacks.insert(0, "soccer")

    pattern = dict(caption=f"ü•° –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å"
                           f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                           f"\n‚ùñ –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ —É–≤–∏–¥–µ—Ç—å –≤—Å–µ –≤–∞—à–∏ üÉè –∫–∞—Ä—Ç—ã "
                           f"–∏ –≤—ã–±—Ä–∞—Ç—å üé¥ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∫ üè¥–æ—Ç—Ä—è–¥—É –≤ –ø–æ–¥–∑–µ–º–µ–ª—å—è"
                           f"\n\n‚ùñ –í—ã–±–µ—Ä–∏—Ç–µ ‚ú® —Ä–µ–¥–∫–æ—Å—Ç—å –∫–∞—Ä—Ç—ã, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞"
                           f"\n‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                           f"\n‚ùñ üÉè –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–∞—Ä—Ç: {total_elements}",
                   reply_markup=inline_builder(
                       buttons,
                       callbacks, row_width=[1]))
    if isinstance(callback, CallbackQuery):
        inline_id = callback.inline_message_id
        media = InputMediaAnimation(media=media_id)
        await callback.message.edit_media(media, inline_id)
        await callback.message.edit_caption(inline_id, **pattern)
    else:
        await callback.answer_animation(animation=media_id, **pattern)


@router.callback_query(F.data.in_(['dg_soccer', 'dg_halloween', 'dg_common', 'dg_rare',
                                   'dg_epic', 'dg_legendary', 'dg_mythical', 'dg_divine']))
async def inventory(callback: CallbackQuery, state: FSMContext):
    await state.update_data(rarity=callback.data)
    inline_id = callback.inline_message_id
    user_id = callback.from_user.id
    invent, universe = await get_inventory(user_id, callback.data)
    if invent == []:
        await callback.answer("‚ùñ ‚úñÔ∏è –£ –≤–∞—Å –Ω–µ—Ç –∫–∞—Ä—Ç –¥–∞–Ω–Ω–æ–π —Ä–µ–¥–∫–æ—Å—Ç–∏", show_alert=True)
        return
    await state.update_data(character=invent[0])
    await state.update_data(universe=universe)
    avatar = character_photo.get_stats(universe, invent[0], 'avatar')
    avatar_type = character_photo.get_stats(universe, invent[0], 'type')
    if avatar_type == 'photo':
        photo = InputMediaPhoto(media=avatar)
    else:
        photo = InputMediaAnimation(media=avatar)
    rarity = character_photo.get_stats(universe, invent[0], 'rarity')
    msg = f"\n‚ùñ ‚ú® –†–µ–¥–∫–æ—Å—Ç—å: {rarity}"
    if universe not in ['Allstars', 'Allstars(old)']:
        strength = character_photo.get_stats(universe, invent[0], 'arena')['strength']
        agility = character_photo.get_stats(universe, invent[0], 'arena')['agility']
        intelligence = character_photo.get_stats(universe, invent[0], 'arena')['intelligence']
        power = character_photo.get_stats(universe, invent[0], 'arena')['power']
        msg = (f"\n‚ùñ ‚ú® –†–µ–¥–∫–æ—Å—Ç—å: {rarity}"
               f"\n‚ùñ üó∫ –í—Å–µ–ª–µ–Ω–Ω–∞—è: {universe}"
               f"\n\n   ‚úäüèª –°–∏–ª–∞: {strength}"
               f"\n   üë£ –õ–æ–≤–∫–æ—Å—Ç—å: {agility}"
               f"\n   üß† –ò–Ω—Ç–µ–ª–µ–∫—Ç: {intelligence}"
               f"\n   ‚öúÔ∏è –ú–æ—â—å: {power}")
    await callback.message.edit_media(photo, inline_id)
    await callback.message.edit_caption(inline_id, caption=f"üé¥ {invent[0]}"
                                                           f"\n ‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                                                           f"{msg}"
                                                           f"\n‚îÄ‚îÄ‚ùÄ*Ã•Àö‚îÄ‚îÄ‚óå‚îÄ‚îÄ‚óå‚îÄ‚îÄ‚ùÄ*Ã•Àö‚îÄ‚îÄ‚îÄ‚îÄ"
                                                           f"\n‚ùñ üîñ 1 –∏–∑ {len(invent)}",
                                        reply_markup=pagination_dungeon())


@router.callback_query(Pagination.filter(F.action.in_(["dg_prev", "dg_next"])))
async def inventory(callback: CallbackQuery, callback_data: Pagination, state: FSMContext):
    try:
        inline_id = callback.inline_message_id
        page_num = int(callback_data.page)
        user_data = await state.get_data()
        invent, universe = await get_inventory(callback.from_user.id, user_data['rarity'])

        if callback_data.action == "dg_next":
            page_num = (page_num + 1) % len(invent)
        elif callback_data.action == "dg_prev":
            page_num = (page_num - 1) % len(invent)

        with suppress(TelegramBadRequest):
            await state.update_data(character=invent[page_num])
            avatar = character_photo.get_stats(universe, invent[page_num], 'avatar')
            avatar_type = character_photo.get_stats(universe, invent[page_num], 'type')
            if avatar_type == 'photo':
                photo = InputMediaPhoto(media=avatar)
            else:
                photo = InputMediaAnimation(media=avatar)
            rarity = character_photo.get_stats(universe, invent[page_num], 'rarity')
            msg = f"\n‚ùñ ‚ú® –†–µ–¥–∫–æ—Å—Ç—å: {rarity}"
            if universe not in ['Allstars', 'Allstars(old)']:
                strength = character_photo.get_stats(universe, invent[page_num], 'arena')['strength']
                agility = character_photo.get_stats(universe, invent[page_num], 'arena')['agility']
                intelligence = character_photo.get_stats(universe, invent[page_num], 'arena')['intelligence']
                power = character_photo.get_stats(universe, invent[page_num], 'arena')['power']
                msg = (f"\n‚ùñ ‚ú® –†–µ–¥–∫–æ—Å—Ç—å: {rarity}"
                       f"\n‚ùñ üó∫ –í—Å–µ–ª–µ–Ω–Ω–∞—è: {universe}"
                       f"\n\n   ‚úäüèª –°–∏–ª–∞: {strength}"
                       f"\n   üë£ –õ–æ–≤–∫–æ—Å—Ç—å: {agility}"
                       f"\n   üß† –ò–Ω—Ç–µ–ª–µ–∫—Ç: {intelligence}"
                       f"\n   ‚öúÔ∏è –ú–æ—â—å: {power}")

            await callback.message.edit_media(photo, inline_id)
            await callback.message.edit_caption(
                inline_id,
                caption=f"üé¥ {invent[page_num]}"
                        f"\n ‚îÄ‚îÄ ‚Ä¢‚úß‚úß‚Ä¢ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
                        f"{msg}"
                        f"\n‚îÄ‚îÄ‚ùÄ*Ã•Àö‚îÄ‚îÄ‚óå‚îÄ‚îÄ‚óå‚îÄ‚îÄ‚ùÄ*Ã•Àö‚îÄ‚îÄ‚îÄ‚îÄ"
                        f"\n‚ùñ üîñ {page_num + 1} –∏–∑ {len(invent)}",
                reply_markup=pagination_dungeon(page=page_num)
            )
        await callback.answer()
    except KeyError:
        await callback.answer("‚ùñ üîÇ –ò–¥—ë—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–∞ —Å–≤—è–∑–∏ —Å —á–µ–º —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –≤—ã–∑–æ–≤–∏—Ç–µ "
                              "ü•° –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –µ—â–µ —Ä–∞–∑", show_alert=True)


@router.callback_query(F.data == "dg_choice_card")
async def change_ch(callback: CallbackQuery, state: FSMContext):
    try:
        user_id = callback.from_user.id
        account = await mongodb.get_user(user_id)
        deck = account["deck_dungeon"]
        data = await state.get_data()
        if data.get('character') in deck.values():
            await callback.answer("‚ùñ üîÇ –≠—Ç–æ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂ —É–∂–µ –µ—Å—Ç—å –≤ –∫–æ–ª–æ–¥–µ", show_alert=True)
            return
        else:
            await mongodb.update_user(user_id, {f"deck_dungeon.{data.get('deck')}": data.get('character')})
            await mongodb.update_user(user_id, {f"deck_dungeon.{data.get('card_universe')}": data.get('universe')})
            await callback.answer("üé¥ –í—ã —É—Å–ø–µ—à–Ω–æ –≤—ã–±—Ä–∞–ª–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞", show_alert=True)
            await choose_card(callback)
    except KeyError:
        await callback.answer("‚ùñ üîÇ –ò–¥—ë—Ç —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–∞ —Å–≤—è–∑–∏ —Å —á–µ–º —Å–µ—Å—Å–∏—è –±—ã–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –≤—ã–∑–æ–≤–∏—Ç–µ "
                              "ü•° –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –µ—â–µ —Ä–∞–∑", show_alert=True)
